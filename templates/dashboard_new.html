<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Intelligence Dashboard - Session42</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .config-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .config-item {
            margin-bottom: 15px;
        }
        
        .config-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .config-item input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover {
            background: #218838;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .steps-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .step-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .step-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-ready {
            background: #d4edda;
            color: #155724;
        }
        
        .status-running {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-success {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .step-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .progress-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .message {
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #007bff;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Results Section Styles */
        .results-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .filter-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .filter-controls label {
            display: flex;
            flex-direction: column;
            font-weight: 600;
            color: #555;
        }
        
        .filter-controls select {
            margin-top: 5px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .contact-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .contact-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .contact-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .contact-info h4 {
            margin: 0 0 5px 0;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .contact-email {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .confidence-badge {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
        }
        
        .confidence-high {
            background: #d4edda;
            color: #155724;
        }
        
        .confidence-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .confidence-low {
            background: #f8d7da;
            color: #721c24;
        }
        
        .confidence-none {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .enrichment-summary {
            margin-top: 15px;
        }
        
        .enrichment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .enrichment-label {
            font-weight: 600;
            color: #495057;
        }
        
        .enrichment-value {
            color: #6c757d;
            text-align: right;
            flex: 1;
            margin-left: 10px;
        }
        
        .trust-tier {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .tier-1 {
            background: #d4edda;
            color: #155724;
        }
        
        .tier-2 {
            background: #fff3cd;
            color: #856404;
        }
        
        .tier-3 {
            background: #f8d7da;
            color: #721c24;
        }
        
        .data-sources {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .source-tag {
            padding: 2px 6px;
            background: #e9ecef;
            border-radius: 10px;
            font-size: 10px;
            color: #495057;
        }
        
        .loading-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading-state i {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }
        
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #6c757d;
            padding: 5px;
        }
        
        .modal-close:hover {
            color: #dc3545;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 70vh;
        }
        
        .detail-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .detail-section h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 5px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            align-items: start;
        }
        
        .detail-label {
            font-weight: 600;
            color: #495057;
        }
        
        .detail-value {
            color: #6c757d;
            word-break: break-word;
        }
        
        .json-viewer {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .phase-timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .phase-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        
        .phase-item {
            position: relative;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .phase-item::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            border: 3px solid white;
            box-shadow: 0 0 0 3px #28a745;
        }
        
        .phase-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .phase-description {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .phase-data {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        /* Table Styles for Step Results */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 14px;
        }
        
        .results-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .results-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        
        .results-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .email-cell {
            font-family: monospace;
            font-size: 12px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .subject-cell {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .gmail-id-cell {
            font-family: monospace;
            font-size: 11px;
            color: #6c757d;
        }
        
        .results-summary {
            margin-bottom: 20px;
        }
        
        /* Knowledge Tree Specific Styles */
        .knowledge-tree-preview {
            margin-top: 20px;
        }
        
        .topic-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .topic-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .topic-count {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            color: #6c757d;
        }
        
        /* Responsive table */
        @media (max-width: 768px) {
            .results-table {
                font-size: 12px;
            }
            
            .results-table th,
            .results-table td {
                padding: 8px;
            }
            
            .email-cell,
            .subject-cell {
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="text-align: left;">
                    <h1>🧠 Strategic Intelligence Dashboard</h1>
                    <p>Claude-Powered Content Consolidation & Intelligence Analysis</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-info" onclick="goToKnowledgeTree()">
                        🌳 Knowledge Tree
                    </button>
                    <button id="viewKnowledgeTreeBtn" class="btn-secondary" onclick="viewKnowledgeTree()">
                        🌳 View Knowledge Tree
                    </button>
                    <button class="btn btn-secondary" onclick="logout()">
                        🚪 Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="messages"></div>

        <!-- Configuration Panel -->
        <div class="config-panel">
            <h3>⚙️ Configuration</h3>
            <div class="config-item">
                <label for="daysBack">📅 Content History Range (Days):</label>
                <input type="number" id="daysBack" value="30" min="1" max="365" />
                <span style="color: #666; font-size: 14px; margin-left: 10px;">How far back to analyze emails and content</span>
            </div>
            
            <div class="action-buttons">
                <button id="sanityTestBtn" class="btn btn-info" onclick="runSanityTest()">
                    🧪 Sanity Test (10 contacts)
                </button>
                
                <button id="startPipelineBtn" class="btn btn-primary" onclick="startFullPipeline()">
                    🚀 Start Full Pipeline
                </button>
                
                <button id="flushBtn" class="btn btn-danger" onclick="flushDatabase()">
                    🗑️ Flush Database
                </button>
                
                <button id="testBtn" class="btn btn-info" onclick="testFunction()">
                    🧪 Test Function
                </button>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="progress-section hidden">
            <h3>📊 Pipeline Progress</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressText">0% Complete</div>
            <button id="stopBtn" class="btn btn-secondary" onclick="stopPipeline()">⏹️ Stop Pipeline</button>
        </div>

        <!-- Individual Steps -->
        <div class="steps-panel">
            <h3>📋 Individual Step Controls</h3>
            <p style="margin-bottom: 20px; color: #666;">Run specific steps independently or inspect results from previous runs.</p>
            
            <div id="stepsContainer">
                <!-- Steps will be dynamically populated here -->
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="steps-panel" style="display: none;">
            <h2>📊 Enrichment Results Viewer</h2>
            <div class="results-toolbar">
                <button onclick="loadEnrichmentResults()" class="btn btn-primary">
                    <i class="fas fa-refresh"></i> Refresh Results
                </button>
                <button onclick="downloadResults()" class="btn btn-info">
                    <i class="fas fa-download"></i> Download JSON
                </button>
                <button onclick="showDomainAnalysis()" class="btn btn-secondary">
                    <i class="fas fa-building"></i> Domain Analysis
                </button>
                <button onclick="toggleResultsSection()" class="btn btn-secondary">
                    <i class="fas fa-eye-slash"></i> Hide Results
                </button>
            </div>
            
            <!-- Statistics Overview -->
            <div id="enrichmentStats" class="stats-grid" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalContacts">-</div>
                    <div class="stat-label">Total Contacts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="enrichedContacts">-</div>
                    <div class="stat-label">Enriched</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="enrichmentRate">-</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="dataSources">-</div>
                    <div class="stat-label">Data Sources</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="domainsAnalyzed">-</div>
                    <div class="stat-label">Domains Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgConfidence">-</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
            </div>
            
            <!-- Filter Controls -->
            <div class="filter-controls">
                <label>
                    Format:
                    <select id="resultsFormat">
                        <option value="summary">Summary View</option>
                        <option value="detailed">Detailed View</option>
                    </select>
                </label>
                <label>
                    Confidence:
                    <select id="confidenceFilter">
                        <option value="all">All Levels</option>
                        <option value="high">High (>0.7)</option>
                        <option value="medium">Medium (0.4-0.7)</option>
                        <option value="low">Low (<0.4)</option>
                    </select>
                </label>
                <label>
                    Trust Tier:
                    <select id="tierFilter">
                        <option value="all">All Tiers</option>
                        <option value="tier_1">Tier 1</option>
                        <option value="tier_2">Tier 2</option>
                        <option value="tier_3">Tier 3</option>
                    </select>
                </label>
            </div>
            
            <!-- Results Grid -->
            <div id="enrichmentResults" class="results-grid">
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading enrichment results...</p>
                </div>
            </div>
            
            <!-- Pagination -->
            <div id="resultsPagination" class="pagination-controls" style="display: none;">
                <button onclick="loadPreviousPage()" class="btn btn-secondary" id="prevBtn" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span id="pageInfo">Page 1 of 1</span>
                <button onclick="loadNextPage()" class="btn btn-secondary" id="nextBtn" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Contact Detail Modal -->
        <div id="contactModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalContactEmail">Contact Details</h3>
                    <button onclick="closeContactModal()" class="modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="contactDetails">
                        <!-- Contact details will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Domain Analysis Modal -->
        <div id="domainModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>🏢 Domain Intelligence Analysis</h3>
                    <button onclick="closeDomainModal()" class="modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="domainAnalysis">
                        <!-- Domain analysis will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let isRunning = false;
        let currentStep = 0;
        
        // Pipeline steps configuration
        const PIPELINE_STEPS = [
            { id: 'contacts', name: 'Extract Official Contacts', description: 'Analyzing 1 year of sent emails...' },
            { id: 'emails', name: 'Collect Recent Communications', description: 'Gathering emails from contact network...' },
            { id: 'augment', name: 'Augment Contact Intelligence', description: 'Enhancing contacts with Claude...' },
            { id: 'tree', name: 'Build Knowledge Tree', description: 'Consolidating content with Claude...' },
            { id: 'intelligence', name: 'Generate Strategic Intelligence', description: 'Running strategic analysis...' }
        ];

        // Utility functions
        function showMessage(text, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
            
            console.log(`${type.toUpperCase()}: ${text}`);
        }

        function updateProgress(percentage, text) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = percentage + '%';
            progressText.textContent = text || `${percentage}% Complete`;
        }

        function updateStepStatus(stepId, status) {
            const statusElement = document.getElementById(`status-${stepId}`);
            if (statusElement) {
                statusElement.className = `step-status status-${status}`;
                statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            }
        }

        function setButtonLoading(buttonId, loading = true) {
            const button = document.getElementById(buttonId);
            if (button) {
                if (loading) {
                    button.innerHTML = '<span class="loading-spinner"></span>' + button.textContent;
                    button.disabled = true;
                } else {
                    button.innerHTML = button.textContent.replace(/^.*?(\w)/, '$1');
                    button.disabled = false;
                }
            }
        }

        // API call wrapper with error handling
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`API call to ${url} failed:`, error);
                showMessage(`API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Main pipeline functions
        async function startFullPipeline() {
            if (isRunning) {
                showMessage('Pipeline is already running!', 'error');
                return;
            }

            console.log('🚀 Starting full pipeline...');
            showMessage('Starting full pipeline...', 'info');
            
            isRunning = true;
            document.getElementById('progressSection').classList.remove('hidden');
            setButtonLoading('startPipelineBtn', true);
            
            try {
                for (let i = 0; i < PIPELINE_STEPS.length; i++) {
                    const step = PIPELINE_STEPS[i];
                    currentStep = i;
                    
                    updateProgress((i / PIPELINE_STEPS.length) * 100, `Running: ${step.name}`);
                    updateStepStatus(step.id, 'running');
                    
                    showMessage(`Running step ${i + 1}: ${step.name}`, 'info');
                    
                    // Simulate API call for now
                    await runStep(step.id);
                    
                    updateStepStatus(step.id, 'success');
                }
                
                updateProgress(100, 'Pipeline completed successfully!');
                showMessage('Pipeline completed successfully!', 'success');
                
            } catch (error) {
                console.error('Pipeline failed:', error);
                showMessage(`Pipeline failed: ${error.message}`, 'error');
                updateStepStatus(PIPELINE_STEPS[currentStep].id, 'error');
            } finally {
                isRunning = false;
                setButtonLoading('startPipelineBtn', false);
            }
        }

        async function runStep(stepId) {
            console.log(`🔄 Running step: ${stepId}`);
            
            try {
                // Map step IDs to actual API endpoints
                const stepEndpoints = {
                    'contacts': '/api/gmail/analyze-sent',
                    'emails': '/api/emails/sync',
                    'augment': '/api/intelligence/enrich-contacts',
                    'tree': '/api/intelligence/build-knowledge-tree',
                    'intelligence': '/api/intelligence/enrichment-results'
                };
                
                const endpoint = stepEndpoints[stepId];
                if (!endpoint) {
                    throw new Error(`Unknown step: ${stepId}`);
                }
                
                // Prepare request data
                let requestData = {};
                
                // Add daysBack configuration for relevant steps
                if (stepId === 'contacts' || stepId === 'emails') {
                    const daysBack = parseInt(document.getElementById('daysBack').value) || 30;
                    if (stepId === "contacts") {
                        requestData.lookback_days = daysBack;
                    } else {
                        requestData.days = daysBack;
                    }
                }
                
                
                // For intelligence step, use GET instead of POST
                if (stepId === 'intelligence') {
                    const result = await apiCall(endpoint, { method: 'GET' });
                    console.log(`✅ Step ${stepId} completed:`, result);
                    return result;
                }
                
                const result = await apiCall(endpoint, { 
                    method: 'POST',
                    body: JSON.stringify(requestData)
                });
                console.log(`✅ Step ${stepId} completed:`, result);
                
                return result;
                
            } catch (error) {
                console.error(`❌ Step ${stepId} failed:`, error);
                throw error;
            }
        }

        async function runIndividualStep(stepId) {
            if (isRunning) {
                showMessage('Cannot run individual step while pipeline is running!', 'error');
                return;
            }

            console.log(`🔄 Running individual step: ${stepId}`);
            showMessage(`Running step: ${PIPELINE_STEPS.find(s => s.id === stepId)?.name}`, 'info');
            
            const buttonId = `runBtn-${stepId}`;
            setButtonLoading(buttonId, true);
            updateStepStatus(stepId, 'running');
            
            try {
                const result = await runStep(stepId);
                updateStepStatus(stepId, 'success');
                showMessage(`Step completed: ${PIPELINE_STEPS.find(s => s.id === stepId)?.name}`, 'success');
            } catch (error) {
                updateStepStatus(stepId, 'error');
                showMessage(`Step failed: ${error.message}`, 'error');
            } finally {
                setButtonLoading(buttonId, false);
            }
        }

        async function inspectStep(stepId) {
            console.log(`🔍 Inspecting step: ${stepId}`);
            showMessage(`Inspecting results for: ${PIPELINE_STEPS.find(s => s.id === stepId)?.name}`, 'info');
            
            // Handle each step with its specific result viewer
            switch(stepId) {
                case 'contacts':
                    await showContactsResults();
                    break;
                case 'emails':
                    await showEmailsResults();
                    break;
                case 'augment':
                case 'intelligence':
                    showResultsSection();
                    await loadEnrichmentResults();
                    break;
                case 'tree':
                    await showKnowledgeTreeResults();
                    break;
                default:
                    showMessage(`Results viewer for ${stepId} not implemented yet`, 'info');
            }
        }

        // Step 1: Show contacts discovered from sent emails
        async function showContactsResults() {
            console.log('📋 Loading contacts results...');
            
            try {
                const response = await apiCall('/api/inspect/contacts', { method: 'GET' });
                
                if (response.success) {
                    showCustomResultsSection('contacts', '📋 Discovered Contacts', buildContactsTableHTML(response));
                } else {
                    throw new Error(response.error || 'Failed to load contacts');
                }
                
            } catch (error) {
                console.error('Failed to load contacts:', error);
                showMessage(`Failed to load contacts: ${error.message}`, 'error');
                showCustomResultsSection('contacts', '📋 Discovered Contacts', `
                    <div class="loading-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load contacts: ${error.message}</p>
                        <button onclick="showContactsResults()" class="btn btn-primary">
                            <i class="fas fa-retry"></i> Retry
                        </button>
                    </div>
                `);
            }
        }

        // Step 2: Show emails collected
        async function showEmailsResults() {
            console.log('📧 Loading emails results...');
            
            try {
                const response = await apiCall('/api/inspect/emails?limit=100', { method: 'GET' });
                
                if (response.success) {
                    showCustomResultsSection('emails', '📧 Collected Emails', buildEmailsTableHTML(response));
                } else {
                    throw new Error(response.error || 'Failed to load emails');
                }
                
            } catch (error) {
                console.error('Failed to load emails:', error);
                showMessage(`Failed to load emails: ${error.message}`, 'error');
                showCustomResultsSection('emails', '📧 Collected Emails', `
                    <div class="loading-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load emails: ${error.message}</p>
                        <button onclick="showEmailsResults()" class="btn btn-primary">
                            <i class="fas fa-retry"></i> Retry
                        </button>
                    </div>
                `);
            }
        }

        // Step 4: Show knowledge tree results
        async function showKnowledgeTreeResults() {
            console.log('🌳 Loading knowledge tree results...');
            
            try {
                const response = await apiCall('/api/inspect/knowledge-tree', { method: 'GET' });
                
                if (response.success && response.knowledge_tree) {
                    showCustomResultsSection('tree', '🌳 Knowledge Tree', buildKnowledgeTreeHTML(response));
                } else {
                    showCustomResultsSection('tree', '🌳 Knowledge Tree', `
                        <div class="loading-state">
                            <i class="fas fa-info-circle"></i>
                            <p>No knowledge tree found. Run the "Build Knowledge Tree" step first.</p>
                        </div>
                    `);
                }
                
            } catch (error) {
                console.error('Failed to load knowledge tree:', error);
                showMessage(`Failed to load knowledge tree: ${error.message}`, 'error');
            }
        }

        // Generic function to show step-specific results
        function showCustomResultsSection(stepId, title, content) {
            // Hide the enrichment results section if it's open
            document.getElementById('resultsSection').style.display = 'none';
            
            // Create or update the custom results section
            let customSection = document.getElementById('customResultsSection');
            if (!customSection) {
                customSection = document.createElement('div');
                customSection.id = 'customResultsSection';
                customSection.className = 'steps-panel';
                customSection.style.display = 'none';
                
                // Insert after the main steps panel
                const stepsPanel = document.querySelector('.steps-panel');
                stepsPanel.parentNode.insertBefore(customSection, stepsPanel.nextSibling);
            }
            
            customSection.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>${title}</h2>
                    <button onclick="hideCustomResults()" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
                ${content}
            `;
            
            customSection.style.display = 'block';
            customSection.scrollIntoView({ behavior: 'smooth' });
        }

        function hideCustomResults() {
            const customSection = document.getElementById('customResultsSection');
            if (customSection) {
                customSection.style.display = 'none';
            }
        }

        // Build contacts table HTML
        function buildContactsTableHTML(response) {
            const contacts = response.contacts || [];
            
            if (contacts.length === 0) {
                return `
                    <div class="loading-state">
                        <i class="fas fa-info-circle"></i>
                        <p>No contacts found. Run "Extract Official Contacts" step first.</p>
                    </div>
                `;
            }
            
            return `
                <div class="results-summary">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${response.total_contacts || contacts.length}</div>
                            <div class="stat-label">Total Contacts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${contacts.filter(c => c.trust_tier === 'tier_1').length}</div>
                            <div class="stat-label">Tier 1 (VIP)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${contacts.filter(c => c.trust_tier === 'tier_2').length}</div>
                            <div class="stat-label">Tier 2 (Important)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${contacts.filter(c => c.trust_tier === 'tier_3').length}</div>
                            <div class="stat-label">Tier 3 (Regular)</div>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Name</th>
                                <th>Domain</th>
                                <th>Trust Tier</th>
                                <th>Frequency</th>
                                <th>Has Enrichment</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${contacts.map(contact => `
                                <tr onclick="showContactDetailsFromTable('${contact.email}')" style="cursor: pointer;">
                                    <td class="email-cell">${contact.email}</td>
                                    <td>${contact.name || '-'}</td>
                                    <td>${contact.domain || '-'}</td>
                                    <td><span class="trust-tier tier-${contact.trust_tier?.split('_')[1] || '3'}">${contact.trust_tier || 'tier_3'}</span></td>
                                    <td>${contact.frequency || 1}</td>
                                    <td>${contact.has_augmentation ? '✅ Yes' : '❌ No'}</td>
                                    <td>${contact.created_at ? new Date(contact.created_at).toLocaleDateString() : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Build emails table HTML
        function buildEmailsTableHTML(response) {
            const emails = response.emails || [];
            
            if (emails.length === 0) {
                return `
                    <div class="loading-state">
                        <i class="fas fa-info-circle"></i>
                        <p>No emails found. Run "Collect Recent Communications" step first.</p>
                    </div>
                `;
            }
            
            return `
                <div class="results-summary">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${response.total_emails || emails.length}</div>
                            <div class="stat-label">Total Emails</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${emails.filter(e => e.content_length > 1000).length}</div>
                            <div class="stat-label">Long Emails (>1K chars)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${new Set(emails.map(e => e.metadata?.from).filter(Boolean)).size}</div>
                            <div class="stat-label">Unique Senders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${emails.filter(e => e.created_at && new Date(e.created_at) > new Date(Date.now() - 7*24*60*60*1000)).length}</div>
                            <div class="stat-label">Recent (7 days)</div>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>From</th>
                                <th>Date</th>
                                <th>Content Length</th>
                                <th>Gmail ID</th>
                                <th>Stored</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${emails.map(email => `
                                <tr onclick="showEmailDetails('${email.gmail_id}')" style="cursor: pointer;">
                                    <td class="subject-cell">${email.metadata?.subject || 'No Subject'}</td>
                                    <td>${email.metadata?.from || '-'}</td>
                                    <td>${email.metadata?.date ? new Date(email.metadata.date).toLocaleDateString() : '-'}</td>
                                    <td>${email.content_length || 0} chars</td>
                                    <td class="gmail-id-cell">${email.gmail_id?.substring(0, 10)}...</td>
                                    <td>${email.created_at ? new Date(email.created_at).toLocaleDateString() : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Build knowledge tree HTML
        function buildKnowledgeTreeHTML(response) {
            const tree = response.knowledge_tree;
            
            return `
                <div class="results-summary">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${Object.keys(tree.topics || {}).length}</div>
                            <div class="stat-label">Topics</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Object.keys(tree.relationships || {}).length}</div>
                            <div class="stat-label">Relationships</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Object.keys(tree.timeline || {}).length}</div>
                            <div class="stat-label">Timeline Events</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${tree.metadata?.updated_at ? '✅' : '❌'}</div>
                            <div class="stat-label">Status</div>
                        </div>
                    </div>
                </div>
                
                <div class="knowledge-tree-preview">
                    <div class="detail-section">
                        <h4>🎯 Key Topics</h4>
                        <div class="topic-list">
                            ${Object.entries(tree.topics || {}).slice(0, 10).map(([topic, data]) => `
                                <div class="topic-item">
                                    <strong>${topic}</strong>
                                    <span class="topic-count">${data.mentions || 0} mentions</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>🔧 Raw Knowledge Tree Data</h4>
                        <div class="json-viewer">
                            ${JSON.stringify(tree, null, 2)}
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="goToKnowledgeTree()" class="btn btn-primary">
                            🌳 Open Full Knowledge Tree Viewer
                        </button>
                    </div>
                </div>
            `;
        }

        // Show contact details from table click
        async function showContactDetailsFromTable(email) {
            console.log(`👤 Showing contact details from table: ${email}`);
            
            try {
                // For now, we'll use the same logic but we might want to fetch fresh data
                showMessage(`Loading details for ${email}...`, 'info');
                
                // This could be enhanced to fetch specific contact details
                showMessage(`Contact details for ${email} would be shown here`, 'info');
                
            } catch (error) {
                console.error('Failed to show contact details:', error);
                showMessage(`Failed to show contact details: ${error.message}`, 'error');
            }
        }

        // Show email details
        async function showEmailDetails(gmailId) {
            console.log(`📧 Showing email details: ${gmailId}`);
            showMessage(`Email details for ${gmailId} would be shown here`, 'info');
        }

        // Enrichment Results Functions
        let currentResultsPage = 1;
        let currentResultsData = null;
        
        function showResultsSection() {
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function toggleResultsSection() {
            const section = document.getElementById('resultsSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        }
        
        async function loadEnrichmentResults() {
            console.log('📊 Loading enrichment results...');
            
            try {
                const format = document.getElementById('resultsFormat')?.value || 'summary';
                const confidenceFilter = document.getElementById('confidenceFilter')?.value || 'all';
                const tierFilter = document.getElementById('tierFilter')?.value || 'all';
                
                const params = new URLSearchParams({
                    format: format,
                    limit: '50',
                    offset: ((currentResultsPage - 1) * 50).toString()
                });
                
                const response = await apiCall(`/api/intelligence/enrichment-results?${params.toString()}`, {
                    method: 'GET'
                });
                
                if (response.success) {
                    currentResultsData = response.data;
                    displayEnrichmentResults(response.data, confidenceFilter, tierFilter);
                    updateEnrichmentStats(response.data);
                    updatePagination(response.data.pagination);
                    showMessage('Enrichment results loaded successfully!', 'success');
                } else {
                    throw new Error(response.error || 'Failed to load results');
                }
                
            } catch (error) {
                console.error('Failed to load enrichment results:', error);
                showMessage(`Failed to load enrichment results: ${error.message}`, 'error');
                
                // Show error state
                document.getElementById('enrichmentResults').innerHTML = `
                    <div class="loading-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load enrichment results: ${error.message}</p>
                        <button onclick="loadEnrichmentResults()" class="btn btn-primary">
                            <i class="fas fa-retry"></i> Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function displayEnrichmentResults(data, confidenceFilter, tierFilter) {
            const resultsContainer = document.getElementById('enrichmentResults');
            const contacts = data.contacts || [];
            
            // Apply filters
            const filteredContacts = contacts.filter(contact => {
                // Confidence filter
                const confidence = contact.confidence || contact.enrichment?.confidence_score || 0;
                if (confidenceFilter === 'high' && confidence <= 0.7) return false;
                if (confidenceFilter === 'medium' && (confidence <= 0.4 || confidence > 0.7)) return false;
                if (confidenceFilter === 'low' && confidence >= 0.4) return false;
                
                // Trust tier filter
                if (tierFilter !== 'all' && contact.trust_tier !== tierFilter) return false;
                
                return true;
            });
            
            if (filteredContacts.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="loading-state">
                        <i class="fas fa-search"></i>
                        <p>No contacts match the current filters</p>
                        <button onclick="resetFilters()" class="btn btn-secondary">Reset Filters</button>
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = filteredContacts.map(contact => {
                const confidence = contact.confidence || contact.enrichment?.confidence_score || 0;
                const confidenceClass = getConfidenceClass(confidence);
                const trustTierClass = `tier-${contact.trust_tier?.split('_')[1] || '3'}`;
                
                // Get enrichment data
                const enrichment = contact.enrichment || {};
                const personData = enrichment.person_data || {};
                const companyData = enrichment.company_data || {};
                const dataSources = enrichment.data_sources || [];
                
                return `
                    <div class="contact-card" onclick="showContactDetails('${contact.email}')">
                        <div class="contact-header">
                            <div class="contact-info">
                                <h4>${contact.name || personData.name || contact.email.split('@')[0]}</h4>
                                <div class="contact-email">${contact.email}</div>
                                <span class="trust-tier ${trustTierClass}">${contact.trust_tier || 'tier_3'}</span>
                            </div>
                            <div class="confidence-badge ${confidenceClass}">
                                ${confidence > 0 ? (confidence * 100).toFixed(0) + '%' : 'N/A'}
                            </div>
                        </div>
                        
                        <div class="enrichment-summary">
                            ${personData.title ? `
                                <div class="enrichment-row">
                                    <span class="enrichment-label">Title:</span>
                                    <span class="enrichment-value">${personData.title}</span>
                                </div>
                            ` : ''}
                            
                            ${companyData.name ? `
                                <div class="enrichment-row">
                                    <span class="enrichment-label">Company:</span>
                                    <span class="enrichment-value">${companyData.name}</span>
                                </div>
                            ` : ''}
                            
                            ${companyData.industry ? `
                                <div class="enrichment-row">
                                    <span class="enrichment-label">Industry:</span>
                                    <span class="enrichment-value">${companyData.industry}</span>
                                </div>
                            ` : ''}
                            
                            <div class="enrichment-row">
                                <span class="enrichment-label">Frequency:</span>
                                <span class="enrichment-value">${contact.frequency || 1}</span>
                            </div>
                            
                            ${dataSources.length > 0 ? `
                                <div class="data-sources">
                                    ${dataSources.map(source => `<span class="source-tag">${source}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getConfidenceClass(confidence) {
            if (confidence > 0.7) return 'confidence-high';
            if (confidence > 0.4) return 'confidence-medium';
            if (confidence > 0) return 'confidence-low';
            return 'confidence-none';
        }
        
        function updateEnrichmentStats(data) {
            const stats = data.statistics || {};
            
            document.getElementById('totalContacts').textContent = stats.total_contacts || 0;
            document.getElementById('enrichedContacts').textContent = stats.enriched_contacts || 0;
            document.getElementById('enrichmentRate').textContent = 
                ((stats.enrichment_rate || 0) * 100).toFixed(1) + '%';
            document.getElementById('avgConfidence').textContent = 
                ((stats.average_confidence || 0) * 100).toFixed(1) + '%';
            
            // Calculate additional stats
            const contacts = data.contacts || [];
            const dataSources = new Set();
            const domains = new Set();
            
            contacts.forEach(contact => {
                if (contact.enrichment?.data_sources) {
                    contact.enrichment.data_sources.forEach(source => dataSources.add(source));
                }
                if (contact.domain) {
                    domains.add(contact.domain);
                }
            });
            
            document.getElementById('dataSources').textContent = dataSources.size;
            document.getElementById('domainsAnalyzed').textContent = domains.size;
            
            // Show stats section
            document.getElementById('enrichmentStats').style.display = 'grid';
        }
        
        function updatePagination(pagination) {
            const { total, limit, offset, returned } = pagination;
            const totalPages = Math.ceil(total / limit);
            const currentPage = Math.floor(offset / limit) + 1;
            
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
            document.getElementById('resultsPagination').style.display = 'flex';
        }
        
        function loadPreviousPage() {
            if (currentResultsPage > 1) {
                currentResultsPage--;
                loadEnrichmentResults();
            }
        }
        
        function loadNextPage() {
            currentResultsPage++;
            loadEnrichmentResults();
        }
        
        function resetFilters() {
            document.getElementById('confidenceFilter').value = 'all';
            document.getElementById('tierFilter').value = 'all';
            displayEnrichmentResults(currentResultsData, 'all', 'all');
        }
        
        async function showContactDetails(email) {
            console.log(`👤 Showing details for: ${email}`);
            
            try {
                // Find contact in current results
                const contact = currentResultsData?.contacts?.find(c => c.email === email);
                if (!contact) {
                    throw new Error('Contact not found in current results');
                }
                
                // Set modal title
                document.getElementById('modalContactEmail').textContent = contact.email;
                
                // Build detailed view
                const detailsHtml = buildContactDetailsHTML(contact);
                document.getElementById('contactDetails').innerHTML = detailsHtml;
                
                // Show modal
                document.getElementById('contactModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Failed to show contact details:', error);
                showMessage(`Failed to show contact details: ${error.message}`, 'error');
            }
        }
        
        function buildContactDetailsHTML(contact) {
            const enrichment = contact.enrichment || {};
            const personData = enrichment.person_data || {};
            const companyData = enrichment.company_data || {};
            const intelligenceSummary = enrichment.intelligence_summary || {};
            
            return `
                <!-- Basic Contact Info -->
                <div class="detail-section">
                    <h4>📋 Basic Information</h4>
                    <div class="detail-grid">
                        <span class="detail-label">Email:</span>
                        <span class="detail-value">${contact.email}</span>
                        
                        <span class="detail-label">Name:</span>
                        <span class="detail-value">${contact.name || personData.name || 'Not available'}</span>
                        
                        <span class="detail-label">Trust Tier:</span>
                        <span class="detail-value">${contact.trust_tier || 'tier_3'}</span>
                        
                        <span class="detail-label">Frequency:</span>
                        <span class="detail-value">${contact.frequency || 1}</span>
                        
                        <span class="detail-label">Domain:</span>
                        <span class="detail-value">${contact.domain || 'Not available'}</span>
                    </div>
                </div>
                
                <!-- Enrichment Information -->
                ${enrichment.confidence_score ? `
                    <div class="detail-section">
                        <h4>🔍 Enrichment Results</h4>
                        <div class="detail-grid">
                            <span class="detail-label">Confidence Score:</span>
                            <span class="detail-value">${(enrichment.confidence_score * 100).toFixed(1)}%</span>
                            
                            <span class="detail-label">Enrichment Method:</span>
                            <span class="detail-value">${enrichment.enrichment_method || 'Not specified'}</span>
                            
                            <span class="detail-label">Enrichment Date:</span>
                            <span class="detail-value">${enrichment.enrichment_timestamp ? new Date(enrichment.enrichment_timestamp).toLocaleString() : 'Not available'}</span>
                            
                            <span class="detail-label">Data Sources:</span>
                            <span class="detail-value">${(enrichment.data_sources || []).join(', ') || 'None'}</span>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Person Data -->
                ${Object.keys(personData).length > 0 ? `
                    <div class="detail-section">
                        <h4>👤 Person Information</h4>
                        <div class="detail-grid">
                            ${personData.title ? `
                                <span class="detail-label">Title:</span>
                                <span class="detail-value">${personData.title}</span>
                            ` : ''}
                            ${personData.seniority_level ? `
                                <span class="detail-label">Seniority:</span>
                                <span class="detail-value">${personData.seniority_level}</span>
                            ` : ''}
                            ${personData.department ? `
                                <span class="detail-label">Department:</span>
                                <span class="detail-value">${personData.department}</span>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Company Data -->
                ${Object.keys(companyData).length > 0 ? `
                    <div class="detail-section">
                        <h4>🏢 Company Information</h4>
                        <div class="detail-grid">
                            ${companyData.name ? `
                                <span class="detail-label">Company:</span>
                                <span class="detail-value">${companyData.name}</span>
                            ` : ''}
                            ${companyData.industry ? `
                                <span class="detail-label">Industry:</span>
                                <span class="detail-value">${companyData.industry}</span>
                            ` : ''}
                            ${companyData.description ? `
                                <span class="detail-label">Description:</span>
                                <span class="detail-value">${companyData.description}</span>
                            ` : ''}
                            ${companyData.technologies ? `
                                <span class="detail-label">Technologies:</span>
                                <span class="detail-value">${companyData.technologies.join(', ')}</span>
                            ` : ''}
                            ${companyData.founded_year ? `
                                <span class="detail-label">Founded:</span>
                                <span class="detail-value">${companyData.founded_year}</span>
                            ` : ''}
                        </div>
                        
                        ${companyData.social_links ? `
                            <h5>🔗 Social Links</h5>
                            <div class="detail-grid">
                                ${Object.entries(companyData.social_links).map(([platform, url]) => `
                                    <span class="detail-label">${platform}:</span>
                                    <span class="detail-value"><a href="${url}" target="_blank">${url}</a></span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <!-- Processing Phases -->
                <div class="detail-section">
                    <h4>⚙️ Processing Phases</h4>
                    <div class="phase-timeline">
                        <div class="phase-item">
                            <div class="phase-title">Phase 1: Contact Discovery</div>
                            <div class="phase-description">Contact found in sent emails analysis</div>
                            <div class="phase-data">Trust tier: ${contact.trust_tier}, Frequency: ${contact.frequency}</div>
                        </div>
                        
                        ${enrichment.enrichment_method ? `
                            <div class="phase-item">
                                <div class="phase-title">Phase 2: Advanced Enrichment</div>
                                <div class="phase-description">Enhanced with ${enrichment.enrichment_method}</div>
                                <div class="phase-data">
                                    Data sources: ${(enrichment.data_sources || []).join(', ')}<br>
                                    Confidence: ${enrichment.confidence_score ? (enrichment.confidence_score * 100).toFixed(1) + '%' : 'N/A'}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="phase-item">
                            <div class="phase-title">Phase 3: Database Storage</div>
                            <div class="phase-description">Permanently stored in PostgreSQL</div>
                            <div class="phase-data">Status: ✅ Stored in contacts.metadata field</div>
                        </div>
                    </div>
                </div>
                
                <!-- Raw JSON Data -->
                <div class="detail-section">
                    <h4>🔧 Raw JSON Data</h4>
                    <div class="json-viewer">
                        ${JSON.stringify(contact, null, 2)}
                    </div>
                </div>
            `;
        }
        
        function closeContactModal() {
            document.getElementById('contactModal').style.display = 'none';
        }
        
        async function showDomainAnalysis() {
            console.log('🏢 Showing domain analysis...');
            
            try {
                // Get domain stats from current results
                if (!currentResultsData?.contacts) {
                    throw new Error('No contact data available');
                }
                
                const domainStats = analyzeDomains(currentResultsData.contacts);
                const analysisHtml = buildDomainAnalysisHTML(domainStats);
                
                document.getElementById('domainAnalysis').innerHTML = analysisHtml;
                document.getElementById('domainModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Failed to show domain analysis:', error);
                showMessage(`Failed to show domain analysis: ${error.message}`, 'error');
            }
        }
        
        function analyzeDomains(contacts) {
            const domainMap = new Map();
            
            contacts.forEach(contact => {
                const domain = contact.domain || (contact.email ? contact.email.split('@')[1] : 'unknown');
                
                if (!domainMap.has(domain)) {
                    domainMap.set(domain, {
                        domain: domain,
                        contacts: [],
                        totalContacts: 0,
                        enrichedContacts: 0,
                        avgConfidence: 0,
                        industries: new Set(),
                        technologies: new Set(),
                        socialPlatforms: new Set()
                    });
                }
                
                const domainData = domainMap.get(domain);
                domainData.contacts.push(contact);
                domainData.totalContacts++;
                
                const enrichment = contact.enrichment || {};
                if (enrichment.confidence_score > 0) {
                    domainData.enrichedContacts++;
                    domainData.avgConfidence += enrichment.confidence_score;
                }
                
                const companyData = enrichment.company_data || {};
                if (companyData.industry) domainData.industries.add(companyData.industry);
                if (companyData.technologies) companyData.technologies.forEach(tech => domainData.technologies.add(tech));
                if (companyData.social_links) Object.keys(companyData.social_links).forEach(platform => domainData.socialPlatforms.add(platform));
            });
            
            // Calculate averages
            domainMap.forEach(domainData => {
                if (domainData.enrichedContacts > 0) {
                    domainData.avgConfidence = domainData.avgConfidence / domainData.enrichedContacts;
                }
                domainData.industries = Array.from(domainData.industries);
                domainData.technologies = Array.from(domainData.technologies);
                domainData.socialPlatforms = Array.from(domainData.socialPlatforms);
            });
            
            return Array.from(domainMap.values()).sort((a, b) => b.totalContacts - a.totalContacts);
        }
        
        function buildDomainAnalysisHTML(domainStats) {
            return `
                <div class="domain-overview">
                    <p><strong>Total Domains:</strong> ${domainStats.length}</p>
                    <p><strong>Total Contacts:</strong> ${domainStats.reduce((sum, d) => sum + d.totalContacts, 0)}</p>
                    <p><strong>Total Enriched:</strong> ${domainStats.reduce((sum, d) => sum + d.enrichedContacts, 0)}</p>
                </div>
                
                <div class="domain-list">
                    ${domainStats.map(domain => `
                        <div class="detail-section">
                            <h4>🌐 ${domain.domain}</h4>
                            <div class="detail-grid">
                                <span class="detail-label">Total Contacts:</span>
                                <span class="detail-value">${domain.totalContacts}</span>
                                
                                <span class="detail-label">Enriched Contacts:</span>
                                <span class="detail-value">${domain.enrichedContacts}</span>
                                
                                <span class="detail-label">Enrichment Rate:</span>
                                <span class="detail-value">${domain.totalContacts > 0 ? ((domain.enrichedContacts / domain.totalContacts) * 100).toFixed(1) + '%' : '0%'}</span>
                                
                                <span class="detail-label">Avg Confidence:</span>
                                <span class="detail-value">${domain.avgConfidence > 0 ? (domain.avgConfidence * 100).toFixed(1) + '%' : 'N/A'}</span>
                                
                                ${domain.industries.length > 0 ? `
                                    <span class="detail-label">Industries:</span>
                                    <span class="detail-value">${domain.industries.join(', ')}</span>
                                ` : ''}
                                
                                ${domain.technologies.length > 0 ? `
                                    <span class="detail-label">Technologies:</span>
                                    <span class="detail-value">${domain.technologies.slice(0, 5).join(', ')}${domain.technologies.length > 5 ? '...' : ''}</span>
                                ` : ''}
                                
                                ${domain.socialPlatforms.length > 0 ? `
                                    <span class="detail-label">Social Platforms:</span>
                                    <span class="detail-value">${domain.socialPlatforms.join(', ')}</span>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function closeDomainModal() {
            document.getElementById('domainModal').style.display = 'none';
        }
        
        async function downloadResults() {
            console.log('💾 Downloading enrichment results...');
            
            try {
                const format = document.getElementById('resultsFormat')?.value || 'detailed';
                const response = await fetch(`/api/intelligence/enrichment-results/download?format=${format}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('access_token') || ''}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Download failed: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `enrichment_results_${format}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showMessage('Enrichment results downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('Failed to download results:', error);
                showMessage(`Failed to download results: ${error.message}`, 'error');
            }
        }
        
        // Add event listeners for filter changes
        document.addEventListener('DOMContentLoaded', function() {
            // Add change listeners to filters
            ['resultsFormat', 'confidenceFilter', 'tierFilter'].forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    element.addEventListener('change', function() {
                        if (currentResultsData) {
                            displayEnrichmentResults(
                                currentResultsData, 
                                document.getElementById('confidenceFilter').value,
                                document.getElementById('tierFilter').value
                            );
                        }
                    });
                }
            });
        });

        async function flushDatabase() {
            if (!confirm('Are you sure you want to flush the database? This will delete all data!')) {
                return;
            }

            console.log('🗑️ Flushing database...');
            showMessage('Flushing database...', 'info');
            
            try {
                const result = await apiCall('/api/system/flush', { method: 'POST' });
                showMessage('Database flushed successfully!', 'success');
                
                // Reset all step statuses
                PIPELINE_STEPS.forEach(step => {
                    updateStepStatus(step.id, 'ready');
                });
                
            } catch (error) {
                showMessage(`Failed to flush database: ${error.message}`, 'error');
            }
        }

        function stopPipeline() {
            if (!isRunning) {
                showMessage('No pipeline is currently running!', 'error');
                return;
            }

            console.log('⏹️ Stopping pipeline...');
            showMessage('Stopping pipeline...', 'info');
            
            isRunning = false;
            document.getElementById('progressSection').classList.add('hidden');
            setButtonLoading('startPipelineBtn', false);
            
            showMessage('Pipeline stopped', 'info');
        }

        function testFunction() {
            console.log('🧪 Test function called!');
            showMessage('Test function executed successfully!', 'success');
            
            // Test that everything is working
            alert('Test function works! Dashboard is properly initialized.');
        }

        async function runSanityTest() {
            console.log('🧪 Starting sanity test...');
            showMessage('Starting sanity test with 10 contacts...', 'info');
            
            // Disable button during test
            setButtonLoading('sanityTestBtn', true);
            
            try {
                const response = await fetch('/api/sanity-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('access_token') || ''}`
                    }
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}`);
                }
                
                if (result.success) {
                    const { results } = result;
                    
                    // Show detailed results
                    let message = '🎉 Sanity test completed successfully!\\n\\n';
                    message += `📞 Step 1: Found ${results.step_1_contacts.contacts_found} contacts\\n`;
                    message += `📧 Step 2: Synced ${results.step_2_emails.emails_synced} emails\\n`;
                    message += `🎯 Step 3: Enriched ${results.step_3_enrichment.contacts_enriched} contacts\\n`;
                    message += `🌳 Step 4: Built knowledge tree with ${results.step_4_knowledge_tree.tree_nodes} nodes\\n\\n`;
                    message += 'All systems working correctly! Ready for full pipeline.';
                    
                    showMessage('Sanity test completed successfully!', 'success');
                    alert(message);
                    
                    // Update all step statuses to success to show they work
                    PIPELINE_STEPS.forEach(step => {
                        updateStepStatus(step.id, 'success');
                    });
                    
                } else {
                    throw new Error(result.error || 'Sanity test failed');
                }
                
            } catch (error) {
                console.error('Sanity test failed:', error);
                showMessage(`Sanity test failed: ${error.message}`, 'error');
                
                // Show which step failed
                const errorDetails = error.message.includes('Step') ? error.message : `Unknown error: ${error.message}`;
                alert(`❌ Sanity Test Failed\\n\\n${errorDetails}\\n\\nCheck the logs for more details.`);
                
            } finally {
                setButtonLoading('sanityTestBtn', false);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                console.log('🚪 Logging out...');
                showMessage('Logging out...', 'info');
                
                // Clear any local session data
                sessionStorage.clear();
                localStorage.clear();
                
                // Redirect to logout endpoint
                window.location.href = '/logout';
            }
        }

        function goToKnowledgeTree() {
            console.log('🌳 Navigating to Knowledge Tree...');
            showMessage('Opening Knowledge Tree page...', 'info');
            
            // Open knowledge tree in new tab
            window.open('/knowledge-tree', '_blank');
        }

        // Initialize dashboard
        function initializeDashboard() {
            console.log('🚀 Initializing dashboard...');
            
            // Create step cards
            const stepsContainer = document.getElementById('stepsContainer');
            
            PIPELINE_STEPS.forEach((step, index) => {
                const stepCard = document.createElement('div');
                stepCard.className = 'step-card';
                stepCard.innerHTML = `
                    <div class="step-header">
                        <div class="step-title">
                            ${index + 1}. ${step.name}
                        </div>
                        <div id="status-${step.id}" class="step-status status-ready">Ready</div>
                    </div>
                    <p style="color: #666; margin-bottom: 15px;">${step.description}</p>
                    <div class="step-actions">
                        <button id="runBtn-${step.id}" class="btn btn-primary" onclick="runIndividualStep('${step.id}')">
                            ▶️ Run Step
                        </button>
                        <button id="inspectBtn-${step.id}" class="btn btn-secondary" onclick="inspectStep('${step.id}')">
                            🔍 Inspect Results
                        </button>
                    </div>
                `;
                stepsContainer.appendChild(stepCard);
            });
            
            showMessage('Dashboard initialized successfully!', 'success');
            console.log('✅ Dashboard initialization complete');
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📖 DOM loaded, initializing dashboard...');
            initializeDashboard();
        });

        // Fallback initialization
        if (document.readyState === 'loading') {
            console.log('📖 Document still loading, waiting for DOMContentLoaded...');
        } else {
            console.log('📖 Document already loaded, initializing immediately...');
            initializeDashboard();
        }
    </script>
</body>
</html> 